{% extends "simulator/base.html" %}

{% block title %}Market{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-center">Market</h1>

    {% if messages %}
        <div>
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="text-end">
        <button class="btn btn-primary mb-3" onclick="updatePrices()">Update Prices</button>
    </div>
    <table class="table table-hover table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Symbol</th>
                <th>Name</th>
                <th>Price</th>
                <th>Sector</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for stock in stocks %}
                <tr id="stock-{{ stock.symbol }}">
                    <td>{{ stock.symbol }}</td>
                    <td>{{ stock.name }}</td>
                    <td class="price">${{ stock.price }}</td>
                    <td>{{ stock.sector }}</td>
                    <td>
                        <form method="post" action="{% url 'buy_stock' stock.symbol %}">
                            {% csrf_token %}
                            <input type="number" name="quantity" class="form-control d-inline w-50" placeholder="Qty" required>
                            <button type="submit" class="btn btn-success">Buy</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    async function updatePrices() {
        const response = await fetch("{% url 'market' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        });
        if (response.ok) {
            alert("Prices updated successfully!");
            location.reload();
        } else {
            alert("Failed to update prices.");
        }
    }
</script>
{% endblock %}
